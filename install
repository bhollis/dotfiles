#!/usr/bin/env zsh -r -x -v -e

# What's the one that forces variables to be defined?

# Detect OS, machine, user, dreamhost, etc
# Work vs home?
# remove ".local", etc

# Install dotfiles!

# Concatenate dotfiles? includes? substitutions?

# Copy symlinks

DOTFILES_PATH=$PWD
SHORTHOST=${HOST/\.local/}
# OS detection, default to Linux
case $(uname) in
    FreeBSD)   OS=FreeBSD ;;
    DragonFly) OS=FreeBSD ;;
    OpenBSD)   OS=OpenBSD ;;
    Darwin)    OS=Darwin  ;;
    SunOS)     OS=SunOS   ;;
    *)         OS=Linux   ;;
esac

# for x in y?
rm -f ~/.emacs
rm -f ~/.emacs.d
ln -s -F "$DOTFILES_PATH/emacs.d" ~/.emacs.d
ln -s -f "$DOTFILES_PATH/gemrc" ~/.gemrc
ln -s -f "$DOTFILES_PATH/gitconfig" ~/.gitconfig
ln -s -f "$DOTFILES_PATH/zshrc" ~/.zshrc
mkdir -p ~/bin
ln -s -f "$DOTFILES_PATH"/bin/* ~/bin

# bin/emacs and bin/ec are only for OS X!
if [ "$OS" != Darwin ]; then
    rm -f ~/bin/emacs
    rm -f ~/bin/ec
fi

# Copy based on OS/machine
if [ -f "$DOTFILES_PATH/emacs.$SHORTHOST" ]; then
    ln -s -f "$DOTFILES_PATH/emacs.$SHORTHOST" ~/.emacs.local
fi

# Delete any broken symlinks
rm -f ~/bin/*(-@D) || echo "No broken symlinks in ~/bin"
rm -f ~/*(-@D) || echo "No broken symlinks in ~"

# if Mac, suppress login thing
touch ~/.hushlogin

# on mac, write prefs? customizations.txt? Brewfile?

# Update submodules
git submodule update --init --recursive

# Homebrew on OSX
if [ "$OS" = Darwin ]; then
    which brew || /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    which brew || eval "$(/opt/homebrew/bin/brew shellenv)"
    brew doctor || echo "Pay attention to these errors!"
    brew update
    brew bundle install --file ~/dotfiles/Brewfile

    # https://stackoverflow.com/questions/39494631/gpg-failed-to-sign-the-data-fatal-failed-to-write-commit-object-git-2-10-0
    if type "gpg" > /dev/null; then
        brew install gnupg
        brew install pinentry-mac
        echo "pinentry-program /opt/homebrew/bin/pinentry-mac" >> ~/.gnupg/gpg-agent.conf
        # echo "test" | gpg --clearsign
    fi

    ln -sf /opt/homebrew/opt/emacs-plus/Emacs.app /Applications
    # TODO: set up keyboard shortcuts, Terminal preferences

    ./setup-macos
fi

# Log in to github and push SSH key
if type "gh" > /dev/null; then
    gh auth login
fi
